name: Deploy to Azure Static Web Apps

on:
  push:
    branches: ["**"]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: src/package-lock.json
      - run: npm ci
        working-directory: ./src
      - run: npm run build
        working-directory: ./src
      - uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      - name: Deploy to Azure Static Web Apps
        run: |
          if [ "${GITHUB_REF_NAME}" = "main" ]; then
            az staticwebapp upload \
              --name "zure-speakers" \
              --resource-group "zure-speakers" \
              --source "./src/out"
          else
            env_name=$(echo "${GITHUB_REF_NAME}" | tr '/_' '-')
            az staticwebapp upload \
              --name "zure-speakers" \
              --resource-group "zure-speakers" \
              --environment "${env_name}" \
              --source "./src/out"
          fi
